SELECT T.NAME as LABEL, COUNT(C.ID) AS COUNT FROM StudentBuildingMonitor.CARDHOLDERS AS C  INNER JOIN StudentBuildingMonitor.NOM_CARDHOLDER_TYPE AS T ON C.TYPE = T.ID  INNER JOIN (SELECT max(p.DATE_TIME) AS LAST_TIME, p.CARDHOLDER_ID AS CARDHOLDER FROM StudentBuildingMonitor.PASSAGES AS P  GROUP BY p.CARDHOLDER_ID  ) as LAST_TIMES on C.ID = LAST_TIMES.CARDHOLDER INNER JOIN (SELECT p2.DATE_TIME AS CT, p2.CARDHOLDER_ID as CH FROM StudentBuildingMonitor.PASSAGES AS p2 WHERE p2.ENTERING = 1  ) as p2 on LAST_TIMES.LAST_TIME = p2.CT and LAST_TIMES.CARDHOLDER = p2.CH GROUP BY C.TYPE  